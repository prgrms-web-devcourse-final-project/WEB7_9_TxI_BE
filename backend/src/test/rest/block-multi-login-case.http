@BASE_URL=http://localhost:8080

### 1) 회원가입 - 성공 (매번 새 이메일로)
POST {{BASE_URL}}/api/v1/auth/signup
Content-Type: application/json

{
  "email": "test1234@test.com",
  "password": "qwer1234",
  "fullName": "Test User",
  "nickname": "테스트유저14",
  "year": "2002",
  "month": "2",
  "day": "11"
}

> {%
    // 가입한 이메일 저장해두면 뒤에서 그대로 로그인 가능
    client.global.set("EMAIL", `test1234@test.com`);
%}

### 2) 로그인 - 성공 (쿠키/토큰 저장)
POST {{BASE_URL}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "{{EMAIL}}",
  "password": "qwer1234"
}

> {%
    // response.body 안전 접근 (optional chaining 금지)
    var body = response.body || {};
    var data = body.data || {};
    var tokens = data.tokens || {};

    if (tokens.accessToken) {
        client.global.set("ACCESS_TOKEN", tokens.accessToken);
    }

    // Set-Cookie 파싱
    var setCookie = response.headers["Set-Cookie"];

    function extractCookies(raw) {
        if (!raw) return null;

        // 배열이면 각 항목에서 name=value만 추출
        if (Array.isArray(raw)) {
            return raw.map(function (c) {
                return c.split(";")[0];
            }).join("; ");
        }

        // 문자열로 합쳐진 경우 대비
        return String(raw)
            .split(",")
            .map(function (s) {
                return s.trim();
            })
            .map(function (c) {
                return c.split(";")[0];
            })
            .join("; ");
    }

    var cookieHeader = extractCookies(setCookie);
    if (cookieHeader) {
        client.global.set("COOKIE", cookieHeader);
    }
%}

### 3) 로그인 2번(싱글디바이스 정책) - 두 번째 로그인으로 첫 번째 토큰이 막히는지
### 3-1) 1st login
POST {{BASE_URL}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "{{EMAIL}}",
  "password": "qwer1234"
}

> {%
    var body = response.body || {};
    var data = body.data || {};
    var tokens = data.tokens || {};
    var t = tokens.accessToken || "";

    client.global.set("ACCESS1", t);

    client.assert(t && t.length > 20, "ACCESS1 is empty");
%}

### 3-2) 2nd login (rotate)
POST {{BASE_URL}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "{{EMAIL}}",
  "password": "qwer1234"
}

> {%
    var body = response.body || {};
    var data = body.data || {};
    var tokens = data.tokens || {};
    var t = tokens.accessToken || "";

    client.global.set("ACCESS2", t);

    var setCookie = response.headers["Set-Cookie"];

    function extractCookies(raw) {
        if (!raw) return null;
        if (Array.isArray(raw)) {
            return raw.map(function (c) {
                return c.split(";")[0];
            }).join("; ");
        }
        return String(raw)
            .split(",")
            .map(function (s) {
                return s.trim();
            })
            .map(function (c) {
                return c.split(";")[0];
            })
            .join("; ");
    }

    var cookieHeader = extractCookies(setCookie);
    if (cookieHeader) client.global.set("COOKIE2", cookieHeader);
%}

### 3-3) 보호 API 호출(예: /api/v1/some-resource) - 1st access로 요청 → ACCESS_OTHER_DEVICE 기대
GET {{BASE_URL}}/api/v1/users/profile
Authorization: Bearer {{ACCESS1}}
Cookie: accessToken={{ACCESS1}}

### 3-4) 보호 API 호출 - 2nd access로 요청 → 성공 기대
GET {{BASE_URL}}/api/v1/users/profile
Authorization: Bearer {{ACCESS2}}
Cookie: accessToken={{ACCESS2}}